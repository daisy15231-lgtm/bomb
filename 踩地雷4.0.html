<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ‚æ¥µæ‹†å½ˆå°ˆå®¶ - è±ªè¯éŸ³æ•ˆç‰ˆ</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        :root {
            --primary-red: #ff4500;
            --bg-dark: #0f0f0f;
            --cell-unrevealed: #4a4a4a;
            --cell-revealed: #d1d1d1;
        }

        body { 
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            background-color: var(--bg-dark); 
            color: #eee; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0;
            overflow-x: hidden;
        }

        h1 { 
            color: var(--primary-red); 
            text-shadow: 0 0 15px var(--primary-red); 
            margin: 20px 0 10px 0;
            font-size: 2rem;
            letter-spacing: 2px;
        }

        .controls { 
            margin-bottom: 20px; 
            background: #1a1a1a; 
            padding: 15px; 
            border-radius: 12px; 
            border: 1px solid #333; 
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .stats { 
            font-size: 1.6rem; 
            margin-bottom: 15px; 
            display: flex; 
            gap: 40px; 
            background: #000; 
            padding: 12px 30px; 
            border-radius: 8px; 
            border: 2px solid var(--primary-red); 
            font-family: 'Courier New', Courier, monospace;
        }

        #timer { color: #00ff00; text-shadow: 0 0 8px #00ff00; min-width: 60px; text-align: right; }
        #timer.warning { color: #ff0000; text-shadow: 0 0 10px #ff0000; animation: shake 0.15s infinite; }

        #game-board { 
            display: grid; 
            background-color: #222; 
            border: 8px solid #333; 
            border-radius: 4px;
            user-select: none;
        }

        .cell { 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            cursor: pointer; 
            background-color: var(--cell-unrevealed); 
            border: 3px outset #666; 
            box-sizing: border-box;
            font-size: 18px;
        }

        .cell.revealed { background-color: var(--cell-revealed); border: 1px solid #999; color: #000; border-style: solid; }
        .cell.mine { background-color: #ff0000; animation: pulse 0.4s infinite alternate; }

        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } }
        @keyframes pulse { from { filter: brightness(1); } to { filter: brightness(1.5); } }

        .nagging-msg { color: #ffae00; font-weight: bold; height: 30px; margin-bottom: 10px; font-size: 1.1rem; }

        button { padding: 8px 16px; font-size: 0.9rem; cursor: pointer; background: #252525; color: #ccc; border: 1px solid #444; border-radius: 4px; transition: all 0.2s; }
        button:hover { background: #333; border-color: var(--primary-red); color: white; }
        button.active { background: var(--primary-red); color: white; box-shadow: 0 0 10px var(--primary-red); }
    </style>
</head>
<body>

    <h1>ğŸ’£ çµ‚æ¥µæ‹†å½ˆå°ˆå®¶</h1>

    <!-- è±å¯Œçš„éŸ³æ•ˆè³‡æºåº« -->
    <audio id="bg-music" loop preload="auto">
        <source src="https://www.soundjay.com/ambient/sounds/underworld-ambience-01.mp3" type="audio/mpeg">
    </audio>
    <audio id="snd-click" preload="auto">
        <source src="https://www.soundjay.com/buttons/sounds/button-16.mp3" type="audio/mpeg">
    </audio>
    <audio id="snd-flag" preload="auto">
        <source src="https://www.soundjay.com/buttons/sounds/button-20.mp3" type="audio/mpeg">
    </audio>
    <audio id="snd-explode" preload="auto">
        <source src="https://www.soundjay.com/mechanical/sounds/explosion-01.mp3" type="audio/mpeg">
    </audio>
    <audio id="snd-win" preload="auto">
        <source src="https://www.soundjay.com/human/sounds/applause-01.mp3" type="audio/mpeg">
    </audio>

    <div class="controls">
        <button id="btn-low">åˆç´šä»»å‹™</button>
        <button id="btn-med">ä¸­ç´šè¡Œå‹•</button>
        <button id="btn-high">ç‰¹ç¨®ä»»å‹™</button>
        <button id="btn-reset" style="background:#400;">é‡å•Ÿå¼•ä¿¡</button>
    </div>

    <div id="nagging" class="nagging-msg">æ­£åœ¨åŠ è¼‰ Python ç’°å¢ƒ...</div>

    <div class="stats">
        <span>â±ï¸ <span id="timer">0</span> s</span>
        <span>ğŸ’£ <span id="mine-count">0</span></span>
    </div>

    <div id="game-board"></div>

    <script type="py">
        from pyscript import document, window
        from pyodide.ffi import create_proxy
        import random
        import time

        class Minesweeper:
            def __init__(self, rows=9, cols=9, mines=10):
                self.rows, self.cols, self.mines_total = rows, cols, mines
                self.timer_loop_proxy = create_proxy(self.update_timer_loop)
                self.reset_game()

            def reset_game(self):
                self.board = [[0 for _ in range(self.cols)] for _ in range(self.rows)]
                self.mine_positions, self.revealed, self.flags = set(), set(), set()
                self.game_over = False
                self.timer_started = False
                self.timer_running = False
                self.start_time = 0
                self.last_move_time = 0
                
                document.querySelector("#timer").innerText = "0"
                document.querySelector("#timer").classList.remove("warning")
                document.querySelector("#nagging").innerText = "é»æ“ŠæŒ‰éˆ•æˆ–æ ¼å­ä¾†å•Ÿå‹•éŸ³è¨Šç³»çµ±ã€‚"
                
                count = 0
                while count < self.mines_total:
                    r, c = random.randint(0, self.rows-1), random.randint(0, self.cols-1)
                    if (r, c) not in self.mine_positions:
                        self.mine_positions.add((r, c))
                        self.board[r][c] = -1
                        count += 1

                for r in range(self.rows):
                    for c in range(self.cols):
                        if self.board[r][c] != -1:
                            val = 0
                            for dr in [-1,0,1]:
                                for dc in [-1,0,1]:
                                    nr, nc = r+dr, c+dc
                                    if 0 <= nr < self.rows and 0 <= nc < self.cols:
                                        if self.board[nr][nc] == -1:
                                            val += 1
                            self.board[r][c] = val
                self.render()

            def play_sfx(self, selector, volume=1.0):
                try:
                    snd = document.querySelector(selector)
                    snd.currentTime = 0
                    snd.volume = volume
                    promise = snd.play()
                    if promise is not None:
                        promise.catch(create_proxy(lambda e: None))
                except: pass

            def render(self):
                board_div = document.querySelector("#game-board")
                board_div.innerHTML = ""
                board_div.style.gridTemplateColumns = f"repeat({self.cols}, 32px)"
                
                for r in range(self.rows):
                    for c in range(self.cols):
                        cell = document.createElement("div")
                        cell.classList.add("cell")
                        cell.setAttribute("id", f"cell-{r}-{c}")
                        
                        click_p = create_proxy(lambda e, row=r, col=c: self.handle_click(row, col))
                        right_p = create_proxy(lambda e, row=r, col=c: self.handle_right_click(e, row, col))
                        
                        cell.addEventListener("click", click_p)
                        cell.addEventListener("contextmenu", right_p)
                        board_div.appendChild(cell)
                        
                document.querySelector("#mine-count").innerText = str(self.mines_total)

            def handle_click(self, r, c):
                if self.game_over or (r, c) in self.flags or (r, c) in self.revealed: return
                self.play_sfx("#snd-click", 0.6)
                
                if not self.timer_started:
                    self.timer_started = True
                    self.timer_running = True
                    self.start_time = time.time()
                    self.last_move_time = self.start_time
                    try:
                        bg = document.querySelector("#bg-music")
                        bg.volume = 0.3
                        bg.play().catch(create_proxy(lambda e: None))
                    except: pass
                    self.update_timer_loop()
                
                self.last_move_time = time.time()
                
                if (r, c) in self.mine_positions:
                    self.play_sfx("#snd-explode", 1.0)
                    self.end_game(False)
                else:
                    self.reveal(r, c)
                    if len(self.revealed) == (self.rows * self.cols - self.mines_total):
                        self.play_sfx("#snd-win", 0.8)
                        self.end_game(True)

            def handle_right_click(self, event, r, c):
                event.preventDefault()
                if self.game_over or (r, c) in self.revealed: return
                self.play_sfx("#snd-flag", 0.7)
                cell = document.querySelector(f"#cell-{r}-{c}")
                if (r, c) in self.flags:
                    self.flags.remove((r, c))
                    cell.innerText = ""
                else:
                    self.flags.add((r, c))
                    cell.innerText = "ğŸš©"
                document.querySelector("#mine-count").innerText = str(self.mines_total - len(self.flags))

            def reveal(self, r, c):
                if (r, c) in self.revealed or (r, c) in self.flags: return
                self.revealed.add((r, c))
                cell = document.querySelector(f"#cell-{r}-{c}")
                cell.classList.add("revealed")
                val = self.board[r][c]
                if val > 0:
                    cell.innerText = str(val)
                    colors = ["", "#2a2aff", "#008800", "#ff0000", "#000088", "#880000", "#008888", "#000000", "#555555"]
                    cell.style.color = colors[val]
                elif val == 0:
                    for dr in [-1,0,1]:
                        for dc in [-1,0,1]:
                            nr, nc = r+dr, c+dc
                            if 0 <= nr < self.rows and 0 <= nc < self.cols:
                                self.reveal(nr, nc)

            def end_game(self, win):
                self.game_over = True
                self.timer_running = False
                try: document.querySelector("#bg-music").pause()
                except: pass
                
                if not win:
                    for (r, c) in self.mine_positions:
                        el = document.querySelector(f"#cell-{r}-{c}")
                        el.classList.add("mine")
                        el.innerText = "ğŸ’£"
                    window.alert("ğŸ’¥ ä»»å‹™å¤±æ•—ï¼ç‚¸å½ˆå·²å¼•çˆ†ã€‚")
                else:
                    window.alert(f"ğŸ† å°ˆæ¥­æ‹†å½ˆè‹±é›„ï¼è€—æ™‚ {int(time.time() - self.start_time)} ç§’")

            def update_timer_loop(self):
                if not self.timer_running: return
                now = time.time()
                elapsed = int(now - self.start_time)
                idle = now - self.last_move_time
                document.querySelector("#timer").innerText = str(elapsed)
                nag = document.querySelector("#nagging")
                music = document.querySelector("#bg-music")
                
                if idle > 60:
                    nag.innerText = "ğŸ’€ è­¦å ±ï¼šç™¼å‘†éä¹…ï¼Œåµæ¸¬åˆ°é²ç–‘ï¼"
                    document.querySelector("#timer").classList.add("warning")
                    music.playbackRate = 1.6
                elif idle > 30:
                    nag.innerText = "â³ å£“åŠ›ä¸Šå‡ä¸­ï¼Œæ™‚é–“ä¸ç­‰äºº..."
                    document.querySelector("#timer").classList.remove("warning")
                    music.playbackRate = 1.3
                else:
                    nag.innerText = "ğŸ•µï¸ æ­£åœ¨å°å¿ƒæ‹†è§£å¼•ä¿¡..."
                    music.playbackRate = 1.0
                window.setTimeout(self.timer_loop_proxy, 1000)

        game = Minesweeper()

        def set_mode(r, c, m, bid):
            game.play_sfx("#snd-click")
            for b in ["#btn-low", "#btn-med", "#btn-high"]:
                document.querySelector(b).classList.remove("active")
            document.querySelector(bid).classList.add("active")
            game.rows, game.cols, game.mines_total = r, c, m
            game.reset_game()

        document.querySelector("#btn-low").onclick = create_proxy(lambda e: set_mode(9, 9, 10, "#btn-low"))
        document.querySelector("#btn-med").onclick = create_proxy(lambda e: set_mode(16, 16, 40, "#btn-med"))
        document.querySelector("#btn-high").onclick = create_proxy(lambda e: set_mode(16, 30, 99, "#btn-high"))
        document.querySelector("#btn-reset").onclick = create_proxy(lambda e: game.reset_game())
        document.querySelector("#btn-low").classList.add("active")
    </script>
</body>
</html>